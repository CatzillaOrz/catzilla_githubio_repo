---
title: 优雅的处理前端异常
date: 2020-06-23 11:13:08
tags:
    - 捕获
    - 异常
categories: 前端
---

##### 前端处理异常的意义

前端一直是距离用户最近的一层，随着产品的日益完善，我们会更加注重用户体验，而前端异常却如鲠在喉，甚是烦人。

异常是不可控的，会影响最终的呈现结果，但是我们有充分的理由去做这样的事情。

1. 增强用户体验；
1. 远程定位问题；
1. 未雨绸缪，及早发现问题；
1. 无法复线问题，尤其是移动端，机型，系统都是问题；
1. 完善的前端方案，前端监控系统；

对于 JS 而言，我们面对的仅仅只是异常，异常的出现不会直接导致 JS 引擎崩溃，最多只会使当前执行的任务终止。

##### 需要处理哪些异常

对于前端来说，我们可做的异常捕获还真不少。总结一下，大概如下：

1. JS 语法错误、代码异常
1. AJAX 请求异常
1. 静态资源加载异常
1. Promise 异常
1. Iframe 异常
1. 跨域 Script error
1. 崩溃和卡顿

##### Try-Catch 的误区

try-catch 只能捕获到同步的运行时错误，对语法和异步错误却无能为力，捕获不到。

1. 同步运行时错误：

```js
try {
    let name = 'mojito';
    console.log(nam);
} catch (e) {
    console.log('捕获err：', e);
}
// output:
```

![20200623115326-2020-06-23-11-53-26-](https://raw.githubusercontent.com/CatzillaOrz/imgcdn/master/vsc_img/20200623115326-2020-06-23-11-53-26-.png)

1. 不能捕获到语法错误，我们修改一下代码，删掉一个单引号

```js
try {
    let name = 'mojito;
    console.log(nam);
} catch(e) {
    console.log('捕获err：', e);
}
// output:
```

![20200623115511-2020-06-23-11-55-12-](https://raw.githubusercontent.com/CatzillaOrz/imgcdn/master/vsc_img/20200623115511-2020-06-23-11-55-12-.png)

1. 异步错误：

```js
try {
    setTimeout(() => {
        undefined.map((v) => v);
    }, 1000);
} catch (e) {
    console.log('捕获到异常：', e);
}
// output:
```

![20200623115755-2020-06-23-11-57-55-](https://raw.githubusercontent.com/CatzillaOrz/imgcdn/master/vsc_img/20200623115755-2020-06-23-11-57-55-.png)

**并没有捕获到异常，这是需要我们特别注意的地方。**

1. window.onerror 不是万能的

当 JS 运行时错误发生时，window 会触发一个 ErrorEvent 接口的 error 事件，并执行 `window.onerror()`。

![20200623152240-2020-06-23-15-22-41-](https://raw.githubusercontent.com/CatzillaOrz/imgcdn/master/vsc_img/20200623152240-2020-06-23-15-22-41-.png)

首先试试同步运行时错误

![20200623152400-2020-06-23-15-24-00-](https://raw.githubusercontent.com/CatzillaOrz/imgcdn/master/vsc_img/20200623152400-2020-06-23-15-24-00-.png)

再试试**语法**错误，是否能捕获

```js
window.onerror = function(message, source, lineno, conlno, error){
    console.log('捕获异常：', {message, source, lineno, conlno, error})
}
let name = 'mojito
// output:
```

![20200623153200-2020-06-23-15-32-00-](https://raw.githubusercontent.com/CatzillaOrz/imgcdn/master/vsc_img/20200623153200-2020-06-23-15-32-00-.png)

居然没有捕获到，`window.onerror`

再来看，`异步`操作捕获：

```js
window.onerror = function(message, source, lineno, conlno, error){
    console.log('捕获异常：', {message, source, lineno, conlno, error})
}
setTimeout(() => {
    Mojito;
})
// output:
```

控制台：

![20200623153610-2020-06-23-15-36-11-](https://raw.githubusercontent.com/CatzillaOrz/imgcdn/master/vsc_img/20200623153610-2020-06-23-15-36-11-.png)

再来试试，网络请求异常情况：

```html
<script>
window.onerror = function(message, source, lineno, conlno, error){
    console.log('捕获异常：', {message, source, lineno, conlno, error})
}
</script>
<img src="./mojito.png">
// output:
```

依然无法捕获，静态资源异常等错误。

---

解决方案：`window.onerror` 函数只有在返回 `true` 的时候，异常才不会向上抛出，否则即使是知道异常的发生控制台还是会显示 `Uncaught Error: xxxxx`

```js
window.onerror = function(message, source, lineno, conlno, error){
    console.log('捕获异常：', {message, source, lineno, conlno, error})
    return true; // 返回 `true` 的时候，异常才不会向上抛出
}
setTimeout(() => {
    Mojito;
})
// output:
```

成功捕获：

![20200623154318-2020-06-23-15-43-19-](https://raw.githubusercontent.com/CatzillaOrz/imgcdn/master/vsc_img/20200623154318-2020-06-23-15-43-19-.png)

###### 注意点

需要注意：

1. onerror 最好写在所有 JS 脚本的前面，否则有可能捕获不到错误；

1. onerror 无法捕获语法错误；

- 结论：
  - 到这里基本就清晰了：在实际的使用过程中，onerror 主要是来捕获预料之外的错误，而 try-catch 则是用来在可预见情况下监控特定的错误，两者结合使用更加高效。

**问题又来了，捕获不到静态资源加载异常怎么办？**

###### window.addEventListener

当一项资源（如图片或脚本）加载失败，加载资源的元素会触发一个 Event 接口的 error 事件，并执行该元素上的 onerror() 处理函数。这些 error 事件不会向上冒泡到 window ，不过（至少在 Firefox 中）能被单一的 window.addEventListener 捕获。

```html
<script>
window.addEventListener('error', (error)  => {
    console.log('捕获异常：', error)
}, true)
</script>
<img src="./mojito.png">
// output:
```

控制台输出

![20200623154811-2020-06-23-15-48-11-](https://raw.githubusercontent.com/CatzillaOrz/imgcdn/master/vsc_img/20200623154811-2020-06-23-15-48-11-.png)

由于网络请求异常不会事件冒泡，因此必须在捕获阶段将其捕捉到才行，但是这种方式虽然可以捕捉到网络请求的异常，但是无法判断 HTTP 的状态是 404 还是其他比如 500 等等，所以还需要配合服务端日志才进行排查分析才可以。

**需要注意:**

- 不同浏览器下返回的 error 对象可能不同，需要注意兼容处理。
- 需要注意避免 addEventListener 重复监听。
